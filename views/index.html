<!DOCTYPE html>
<html lang="de" class="h-full text-white">
<head>
    <!-- Head-Inhalt bleibt unverändert -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WF-TECH Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>:root{/* ... CSS unverändert ... */}</style>
</head>
<body class="h-full">
    <div id="background-animation"></div>
    <div id="app" class="content-wrapper p-4 sm:p-6 lg:p-8 flex flex-col fade-in-up">
        
        <header><!-- Header bleibt unverändert --></header>

        <main id="public-view" class="flex-grow w-full">
            <!-- Öffentliche Ansicht bleibt unverändert -->
        </main>
        
        <main id="private-view" class="flex-grow w-full hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
                <!-- SPOTIFY WIDGET NEU -->
                <div id="spotify-widget" class="widget rounded-2xl p-6 flex flex-col justify-center items-center text-center">
                    <!-- Inhalt wird per JavaScript dynamisch eingefügt -->
                    <p>Lade Spotify-Status...</p>
                </div>
                <!-- Andere private Widgets bleiben unverändert -->
            </div>
            <!-- Rest der privaten Ansicht bleibt unverändert -->
        </main>
        
        <footer class="mt-12 text-gray-500 flex justify-between items-center w-full">
            <!-- Footer bleibt unverändert -->
        </footer>
    </div>

    <!-- Login Modal bleibt unverändert -->
    <div id="login-modal" class="modal-overlay hidden">
        <!-- ... -->
    </div>

    <script>
        // --- Hilfsfunktionen (unverändert) ---
        function getCalendarWeek(date) { /*...*/ }
        function updateClock() { /*...*/ }
        function getWeatherIconClass(iconCode) { /*...*/ }

        // --- View & Auth Logic (unverändert) ---
        function toggleView(isLoggedIn, username = '') { /*...*/ }
        
        // --- Spotify Widget Funktion NEU ---
        function updateSpotifyWidget() {
            const widget = document.getElementById('spotify-widget');
            if (!widget) return;

            fetch('/api/spotify/player')
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        widget.innerHTML = `<p class="text-red-400">Spotify Fehler</p>`;
                        return;
                    }
                    if (!data.connected) {
                        widget.innerHTML = `
                            <i class="fab fa-spotify text-5xl text-green-500 mb-3"></i>
                            <h3 class="text-xl font-bold">Spotify verbinden</h3>
                            <button onclick="window.location.href='/connect/spotify'" class="mt-3 action-btn text-white font-bold py-2 px-4 rounded-lg text-sm">Verbinden</button>
                        `;
                    } else if (data.item) {
                        widget.innerHTML = `
                            <div class="flex gap-6 items-center w-full">
                                <img src="${data.item.album.images[0].url}" alt="Album Art" class="w-24 h-24 rounded-lg shadow-lg">
                                <div class="text-left flex-grow">
                                    <h3 class="font-bold text-lg truncate">${data.item.name}</h3>
                                    <p class="text-gray-400 truncate">${data.item.artists.map(a => a.name).join(', ')}</p>
                                    <div class="flex items-center gap-4 mt-2">
                                        <p class="text-2xl text-gray-400"><i class="fas fa-backward-step"></i></p>
                                        <p class="text-4xl">${data.is_playing ? '<i class="fas fa-pause-circle"></i>' : '<i class="fas fa-play-circle"></i>'}</p>
                                        <p class="text-2xl text-gray-400"><i class="fas fa-forward-step"></i></p>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                         widget.innerHTML = `<p>Auf keinem Gerät wird Musik abgespielt.</p>`;
                    }
                })
                .catch(err => {
                    widget.innerHTML = `<p class="text-red-400">Spotify Status konnte nicht geladen werden.</p>`;
                    console.error('Spotify Widget Fehler:', err);
                });
        }

        // --- Initialisierung & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            updateClock(); setInterval(updateClock, 60000);
            
            fetch('/api/auth/status').then(res => res.json()).then(data => {
                toggleView(data.loggedIn, data.username);
                if(data.loggedIn) {
                    // NEU: Spotify Widget aktualisieren, wenn eingeloggt
                    updateSpotifyWidget();
                }
            }).catch(() => toggleView(false));
            
            // Login-Formular und andere Listener (unverändert)
            // ...
        });
    </script>
</body>
</html>
